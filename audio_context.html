<!doctype html>
<head>
  <title>Web Audio Api - Audio Context</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

<style>

  :root {
    --flex-direction: column;
    --line-height: 4em;
  }

  @media(min-width: 250px) {
    :root {
      --flex-direction: row;
      --line-height: 8em;
    }
  }

  form fieldset { display: none }

  h1 {
    text-align: center;
  }

  main {
    outline: thick double;
    background-color: whitesmoke;
  }

  fieldset {
    display: flex;
    border: none;
    background: yellow;
  }

  form > fieldset {
    flex-direction: var(--flex-direction);
  }

  fieldset fieldset {
    background: red;
  }

  fieldset input[type="range"] {
    width: 20vw;
    display: inline-block;
    top: 0.3em;
    position: relative;
  }

  form > fieldset > label {
    background: turquoise;
    line-height: var(--line-height);
  }

  form > header {
    background: yellow;
  }

  [type="checkbox"] {
  }

</style>

</head>

<body>

  <header>
   <h1>DevPunks Sequencer</h1>
  </header>

<main>

  <form action=#>

    <header>

      <label>
        BPM
        <input name=bpm value=251 min=10 max=522 type=range>
      </label>

      <label>
        Play
        <input name=play value='' type=checkbox >
      </label>
    </header>

    <fieldset>

      <legend>Sweep</legend>

      <label>
        Attack
        <input name="attack" value="0.2" min="0" max="1" step="0.1" type="range">
      </label>

      <label>
        Release
        <input name="release" value="0.5" min="0" max="1" step="0.1" type="range">
      </label>

      <fieldset>
  
        <legend hidden>Checkboxes</legend>
  
        <label>
          <input name=pads type="checkbox">
        </label>
  
        <label>
          <input name=pads type="checkbox">
        </label>
  
        <label>
          <input name=pads type="checkbox">
        </label>
  
        <label>
          <input name=pads type="checkbox">
        </label>
  
      </fieldset>

    </fieldset>

    <fieldset>
  
      <legend>Pulse</legend>
  
      <label>
        Hz
        <input name="hertz" value="880" min="660" max="1320" step="1" type="range">
      </label>
  
      <label>
        LFO
        <input name="lfo" value="30" min="20" max="40" step="1" type="range">
      </label>
  
    <fieldset>
  
      <legend hidden>Checkboxes</legend>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
    </fieldset>
  
    </fieldset>

    <fieldset>
      <legend>Noise</legend>
  
      <label>
        Duration
        <input name="duration" value="1" min="0" max="2" step="0.1" type="range">
      </label>
  
      <label>
        Band
        <input name="band" value="1000" min="400" max="1200" step="5" type="range">
      </label>
  
      <fieldset>
  
      <legend hidden>Checkboxes</legend>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
    </fieldset>
  
    </fieldset>

    <fieldset>
  
      <legend>DTMF</legend>
  
        <label>
          Rate
          <input name="rate" value="1" min="0.1" max="2" step="0.1" type="range">
        </label>
  
    <fieldset>
  
      <legend hidden>Checkboxes</legend>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
      <label>
        <input name=pads type="checkbox">
      </label>
  
    </fieldset>
  
    </fieldset>

  </form>

</main>


<script>


void (function initialize () {

  const
    form = document.querySelector ('main > form')
  , header = form.querySelector('header')
  , bpm  = header.querySelector('[name=bpm]')
  , play = header.querySelector('[name=play]')
  , fieldsets = form.querySelectorAll ('fieldset')


  console.log('Beatz', bpm.value)

  bpm.addEventListener('change', time)

  // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event
  play.addEventListener('click', sequence)

  for (let fieldset of fieldsets)
    configure(fieldset)

})() // run program

function time(event) {
  let counter = 0

  const
    MILLISECONDS_PER_MINUTE = 60 * 1000
  , BEATS_PER_MINUTE = Number( event.target.value )
  , MILLISECONDS_PER_BEAT =
      MILLISECONDS_PER_MINUTE / BEATS_PER_MINUTE

  console.log("BPM", BEATS_PER_MINUTE)
  console.log("Milliseconds per beat", Math.round(MILLISECONDS_PER_BEAT))

  setInterval(() => console.log('beat', counter++), MILLISECONDS_PER_BEAT)
}

function sequence(event) {
  const
    playing = event.target.checked
  , url = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'
  , sound = new Audio(url)

  
  if(playing){
    console.log('paused', sound.paused)

    sound.addEventListener('canplaythrough', function () {
      sound.play()
      console.log('paused', sound.paused)
    })
  } else { // pause
    sound.pause()
    console.log('paused', sound.paused)
  }
}

function configure(fieldset) {
  const ranges = fieldset.querySelectorAll ('[type=range]')
    , checkboxes = fieldset.querySelectorAll ('[type=checkbox]')

  for (let range of ranges) {
    // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event
    // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
    range.addEventListener('input', listen)
  }

  for (let box of checkboxes) {
  // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event
  // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
  box.addEventListener('change', listen)
  }
} // configure

// ----------------------------------------------------------------------
// Events - https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Building_blocks/Events
// Event Handlers - https://developer.mozilla.org/en-US/docs/Web/Events
// e(vent) - https://developer.mozilla.org/en-US/docs/Web/API/Event
// ----------------------------------------------------------------------
function listen(e) {
  e.preventDefault()
  // https://developer.mozilla.org/en-US/docs/Web/API/Event/preventDefault

  console.log('Event listener for DOM element:', e.target)
} // listen

// ----------------------------------------------------------------------
// https://developer.mozilla.org/en-US/docs/Web/API/FormDataEvent
// https://developer.mozilla.org/en-US/docs/Web/API/FormDataEvent/FormDataEvent
// ----------------------------------------------------------------------
function formdata(e) {
  e.preventDefault() // https://developer.mozilla.org/en-US/docs/Web/API/Event/preventDefault

  console.log('FormData:', e.formdata)
} // formdata

</script>

</body>